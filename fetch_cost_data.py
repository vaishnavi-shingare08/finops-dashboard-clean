import boto3 import sqlite3 import os from datetime import datetime, timedelta from dotenv import load_dotenv  # --- Load AWS credentials from .env file --- load_dotenv()  AWS_ACCESS_KEY = os.getenv("AWS_ACCESS_KEY_ID") AWS_SECRET_KEY = os.getenv("AWS_SECRET_ACCESS_KEY") REGION = os.getenv("AWS_REGION", "ap-south-1")  # default region if not set  # --- Connect to AWS Cost Explorer --- client = boto3.client(     'ce',     aws_access_key_id=AWS_ACCESS_KEY,     aws_secret_access_key=AWS_SECRET_KEY,     region_name=REGION )  # --- Connect to SQLite DB --- conn = sqlite3.connect('finops_data.db') cursor = conn.cursor()  # --- Create table if it doesn't exist --- cursor.execute(''' CREATE TABLE IF NOT EXISTS aws_costs (     date TEXT,     service TEXT,     amount REAL ) ''')  # --- Fetch Yesterday’s Cost --- end = datetime.utcnow().date() start = end - timedelta(days=1)  response = client.get_cost_and_usage(     TimePeriod={'Start': str(start), 'End': str(end)},     Granularity='DAILY',     Metrics=['UnblendedCost'],     GroupBy=[{'Type': 'DIMENSION', 'Key': 'SERVICE'}] )  # --- Parse and Insert into DB --- for group in response['ResultsByTime'][0]['Groups']:     service = group['Keys'][0]     amount = float(group['Metrics']['UnblendedCost']['Amount'])     cursor.execute("INSERT INTO aws_costs VALUES (?, ?, ?)", (str(start), service, amount))  conn.commit() conn.close()  print("✅ Data stored successfully!")
